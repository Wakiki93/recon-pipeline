---
phase: 01-foundation-configuration
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - internal/storage/bolt.go
  - internal/storage/scans.go
  - internal/storage/filesystem.go
  - go.mod
  - go.sum
autonomous: true

must_haves:
  truths:
    - "Scan metadata persists to bbolt database and can be retrieved by ID or target"
    - "Scan directories are created with consistent naming (scans/domain_timestamp/)"
    - "Multiple scans for the same target are stored independently with timestamps"
  artifacts:
    - path: "internal/storage/bolt.go"
      provides: "bbolt database initialization and lifecycle"
      exports: ["Store", "NewStore", "Close"]
    - path: "internal/storage/scans.go"
      provides: "Scan metadata CRUD operations"
      exports: ["SaveScan", "GetScan", "ListScans", "GetLatestScan"]
    - path: "internal/storage/filesystem.go"
      provides: "Scan directory creation and path helpers"
      exports: ["CreateScanDir", "ScanDirPath"]
  key_links:
    - from: "internal/storage/scans.go"
      to: "internal/models/scan.go"
      via: "marshals ScanMeta to/from bbolt"
      pattern: "models\\.ScanMeta"
    - from: "internal/storage/bolt.go"
      to: "go.etcd.io/bbolt"
      via: "bbolt Open and bucket creation"
      pattern: "bbolt\\.Open"
    - from: "internal/storage/filesystem.go"
      to: "internal/config/config.go"
      via: "reads ScanDir from config"
      pattern: "config\\.Config"
---

<objective>
Implement persistent storage layer using bbolt for scan metadata and filesystem helpers for scan directory creation.

Purpose: Phases 2-7 all write scan results -- they need a storage layer that persists metadata and organizes output files in structured directories.
Output: Working bbolt store with scan CRUD and filesystem directory creator.
</objective>

<execution_context>
@C:/Users/Hakim/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Hakim/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-configuration/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement bbolt database wrapper and scan metadata storage</name>
  <files>internal/storage/bolt.go, internal/storage/scans.go, go.mod, go.sum</files>
  <action>
    1. Run `go get go.etcd.io/bbolt@latest` to add bbolt dependency.

    2. Create `internal/storage/bolt.go`:
       - Package `storage`
       - `type Store struct` with db (*bbolt.DB) field
       - `func NewStore(path string) (*Store, error)` -- opens bbolt DB at path with 0600 permissions and 1s timeout. Creates buckets: "scans", "scan_index" (for target->scan_id lookups). Return error if open fails.
       - `func (s *Store) Close() error` -- closes the bbolt DB
       - Bucket name constants: `bucketScans = "scans"`, `bucketScanIndex = "scan_index"`

    3. Create `internal/storage/scans.go`:
       - `func (s *Store) SaveScan(meta *models.ScanMeta) error` -- JSON-marshals ScanMeta, stores under key=meta.ID in "scans" bucket. Also stores target->[]scan_id mapping in "scan_index" bucket (append to existing list).
       - `func (s *Store) GetScan(id string) (*models.ScanMeta, error)` -- retrieves and unmarshals by ID. Returns nil, nil if not found.
       - `func (s *Store) ListScans(target string) ([]*models.ScanMeta, error)` -- looks up scan IDs for target in index, retrieves each. Returns sorted by StartedAt descending (newest first).
       - `func (s *Store) GetLatestScan(target string) (*models.ScanMeta, error)` -- convenience: returns most recent scan for target. Returns nil, nil if no scans exist.
       - `func (s *Store) UpdateScanStatus(id string, status models.ScanStatus) error` -- loads scan, updates Status field (and CompletedAt if status is Complete/Failed), saves back.
       - Use `encoding/json` for serialization (bbolt stores []byte values).

    4. Run `go build ./...` to verify compilation.
  </action>
  <verify>Run `go build ./...` -- must succeed with zero errors.</verify>
  <done>bbolt Store opens/closes cleanly. ScanMeta can be saved, retrieved by ID, listed by target, and status-updated. Index enables target-based lookups.</done>
</task>

<task type="auto">
  <name>Task 2: Implement scan directory creation and path helpers</name>
  <files>internal/storage/filesystem.go</files>
  <action>
    1. Create `internal/storage/filesystem.go`:
       - `func ScanDirPath(baseDir string, target string, startedAt time.Time) string` -- returns path like "scans/example.com_20260216_143022". Format: {baseDir}/{target}_{YYYYMMDD}_{HHMMSS}. Sanitize target (replace non-alphanumeric except dots/hyphens with underscore).
       - `func CreateScanDir(baseDir string, target string, startedAt time.Time) (string, error)` -- calls ScanDirPath, creates directory with os.MkdirAll(path, 0755), returns the created path. Also creates subdirectories: "reports/" (for markdown reports) and "raw/" (for raw tool output).
       - `func SanitizeTarget(target string) string` -- replaces characters unsafe for filesystem paths. Allow alphanumeric, dots, hyphens. Replace everything else with underscore.
       - Helper: `func EnsureDir(path string) error` -- os.MkdirAll wrapper.

    2. Run `go build ./...` to verify compilation.
  </action>
  <verify>Run `go build ./...` -- must succeed. Run `go vet ./...` -- no issues.</verify>
  <done>ScanDirPath produces consistent directory names from target+timestamp. CreateScanDir creates the directory tree with reports/ and raw/ subdirectories. Target names are filesystem-safe.</done>
</task>

</tasks>

<verification>
- `go build ./...` succeeds
- `go vet ./...` reports no issues
- Storage package imports models package correctly
- bbolt operations use proper bucket creation in NewStore
- Filesystem paths use OS-appropriate separators (filepath.Join, not string concat)
</verification>

<success_criteria>
bbolt database opens, stores scan metadata as JSON, retrieves by ID and target, supports status updates. Filesystem helper creates structured scan directories (scans/target_timestamp/reports/, scans/target_timestamp/raw/). All code compiles.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-configuration/01-02-SUMMARY.md`
</output>
